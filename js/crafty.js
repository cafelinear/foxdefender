!function(window,initComponents,undefined){var Crafty=function(selector){return new Crafty.fn.init(selector)},GUID,FPS,frame,components,entities,handlers,onloads,tick,requestID,noSetter,loops,milliSecPerFrame,nextGameTick,slice,rlist,rspace,initState=function(){GUID=1;FPS=50;frame=1;components={};entities={};handlers={};onloads=[];tick;requestID;noSetter;loops=0;milliSecPerFrame=1e3/FPS;nextGameTick=(new Date).getTime();slice=Array.prototype.slice;rlist=/\s*,\s*/;rspace=/\s+/};initState();Crafty.fn=Crafty.prototype={init:function(selector){if(typeof selector==="string"){var elem=0,e,current,and=false,or=false,del,comps,score,i,l;if(selector==="*"){i=0;for(e in entities){this[i]=+e;i++}this.length=i;if(i===1){return entities[this[0]]}return this}if(selector.indexOf(",")!==-1){or=true;del=rlist}else if(selector.indexOf(" ")!==-1){and=true;del=rspace}for(e in entities){if(!entities.hasOwnProperty(e))continue;current=entities[e];if(and||or){comps=selector.split(del);i=0;l=comps.length;score=0;for(;i<l;i++)if(current.__c[comps[i]])score++;if(and&&score===l||or&&score>0)this[elem++]=+e}else if(current.__c[selector])this[elem++]=+e}if(elem>0&&!and&&!or)this.extend(components[selector]);if(comps&&and)for(i=0;i<l;i++)this.extend(components[comps[i]]);this.length=elem;if(elem===1){return entities[this[elem-1]]}}else{if(!selector){selector=0;if(!(selector in entities))entities[selector]=this}if(!(selector in entities)){this.length=0;return this}this[0]=selector;this.length=1;if(!this.__c)this.__c={};if(!entities[selector])entities[selector]=this;return entities[selector]}return this},setName:function(name){var entityName=String(name);this._entityName=entityName;this.trigger("NewEntityName",entityName);return this},addComponent:function(id){var uninit=[],c=0,ul,i=0,l,comps,comp;if(arguments.length>1){l=arguments.length;for(;i<l;i++){uninit.push(arguments[i])}}else if(id.indexOf(",")!==-1){comps=id.split(rlist);l=comps.length;for(;i<l;i++){uninit.push(comps[i])}}else{uninit.push(id)}ul=uninit.length;for(;c<ul;c++){if(this.__c[uninit[c]]==true)continue;this.__c[uninit[c]]=true;comp=components[uninit[c]];this.extend(comp);if(comp&&"init"in comp){comp.init.call(this)}}this.trigger("NewComponent",uninit);return this},toggleComponent:function(toggle){var i=0,l,comps;if(arguments.length>1){l=arguments.length;for(;i<l;i++){if(this.has(arguments[i])){this.removeComponent(arguments[i])}else{this.addComponent(arguments[i])}}}else if(toggle.indexOf(",")!==-1){comps=toggle.split(rlist);l=comps.length;for(;i<l;i++){if(this.has(comps[i])){this.removeComponent(comps[i])}else{this.addComponent(comps[i])}}}else{if(this.has(toggle)){this.removeComponent(toggle)}else{this.addComponent(toggle)}}return this},requires:function(list){var comps=list.split(rlist),i=0,l=comps.length,comp;for(;i<l;++i){comp=comps[i];if(!this.has(comp))this.addComponent(comp)}return this},removeComponent:function(id,soft){if(soft===false){var props=components[id],prop;for(prop in props){delete this[prop]}}delete this.__c[id];this.trigger("RemoveComponent",id);return this},has:function(id){return!!this.__c[id]},attr:function(key,value){if(arguments.length===1){if(typeof key==="string"){return this[key]}this.extend(key);this.trigger("Change",key);return this}this[key]=value;var change={};change[key]=value;this.trigger("Change",change);return this},toArray:function(){return slice.call(this,0)},timeout:function(callback,duration){this.each(function(){var self=this;setTimeout(function(){callback.call(self)},duration)});return this},bind:function(event,callback){if(this.length===1){if(!handlers[event])handlers[event]={};var h=handlers[event];if(!h[this[0]])h[this[0]]=[];h[this[0]].push(callback);return this}this.each(function(){if(!handlers[event])handlers[event]={};var h=handlers[event];if(!h[this[0]])h[this[0]]=[];h[this[0]].push(callback)});return this},unbind:function(event,callback){this.each(function(){var hdl=handlers[event],i=0,l,current;if(hdl&&hdl[this[0]])l=hdl[this[0]].length;else return this;if(!callback){delete hdl[this[0]];return this}for(;i<l;i++){current=hdl[this[0]];if(current[i]==callback){current.splice(i,1);i--}}});return this},trigger:function(event,data){if(this.length===1){if(handlers[event]&&handlers[event][this[0]]){var callbacks=handlers[event][this[0]],i=0,l=callbacks.length;for(;i<l;i++){callbacks[i].call(this,data)}}return this}this.each(function(){if(handlers[event]&&handlers[event][this[0]]){var callbacks=handlers[event][this[0]],i=0,l=callbacks.length;for(;i<l;i++){callbacks[i].call(this,data)}}});return this},each:function(func){var i=0,l=this.length;for(;i<l;i++){if(!entities[this[i]])continue;func.call(entities[this[i]],i)}return this},clone:function(){var comps=this.__c,comp,prop,clone=Crafty.e();for(comp in comps){clone.addComponent(comp)}for(prop in this){if(prop!="0"&&prop!="_global"&&prop!="_changed"&&typeof this[prop]!="function"&&typeof this[prop]!="object"){clone[prop]=this[prop]}}return clone},setter:function(prop,callback){if(Crafty.support.setter){this.__defineSetter__(prop,callback)}else if(Crafty.support.defineProperty){Object.defineProperty(this,prop,{set:callback,configurable:true})}else{noSetter.push({prop:prop,obj:this,fn:callback})}return this},destroy:function(){this.each(function(){this.trigger("Remove");for(var e in handlers){this.unbind(e)}delete entities[this[0]]})}};Crafty.fn.init.prototype=Crafty.fn;Crafty.extend=Crafty.fn.extend=function(obj){var target=this,key;if(!obj)return target;for(key in obj){if(target===obj[key])continue;target[key]=obj[key]}return target};Crafty.extend({init:function(w,h,stage_elem){Crafty.viewport.init(w,h,stage_elem);this.trigger("Load");this.timer.init();return this},getVersion:function(){return"0.5.4"},stop:function(clearState){this.timer.stop();if(clearState){Crafty.audio.remove();if(Crafty.stage&&Crafty.stage.elem.parentNode){var newCrStage=document.createElement("div");newCrStage.id=Crafty.stage.elem.id;Crafty.stage.elem.parentNode.replaceChild(newCrStage,Crafty.stage.elem)}initState();initComponents(Crafty,window,window.document)}Crafty.trigger("CraftyStop");return this},pause:function(toggle){if(arguments.length==1?toggle:!this._paused){this.trigger("Pause");this._paused=true;setTimeout(function(){Crafty.timer.stop()},0);Crafty.keydown={}}else{this.trigger("Unpause");this._paused=false;setTimeout(function(){Crafty.timer.init()},0)}return this},isPaused:function(){return this._paused},timer:{prev:+new Date,current:+new Date,currentTime:+new Date,frames:0,frameTime:0,init:function(){var onFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null;if(onFrame){tick=function(){Crafty.timer.step();requestID=onFrame(tick)};tick()}else{tick=setInterval(function(){Crafty.timer.step()},1e3/FPS)}},stop:function(){Crafty.trigger("CraftyStopTimer");if(typeof tick==="number")clearInterval(tick);var onFrame=window.cancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||null;if(onFrame)onFrame(requestID);tick=null},step:function(){loops=0;this.currentTime=+new Date;if(this.currentTime-nextGameTick>60*milliSecPerFrame){nextGameTick=this.currentTime-milliSecPerFrame}while(this.currentTime>nextGameTick){Crafty.trigger("EnterFrame",{frame:frame++});nextGameTick+=milliSecPerFrame;loops++}if(loops){Crafty.DrawManager.draw()}if(this.currentTime>this.frameTime){Crafty.trigger("MessureFPS",{value:this.frame});this.frame=0;this.frameTime=this.currentTime+1e3}else{this.frame++}},getFPS:function(){return FPS},simulateFrames:function(frames){while(frames-->0){Crafty.trigger("EnterFrame",{frame:frame++})}Crafty.DrawManager.draw()}},e:function(){var id=UID(),craft;entities[id]=null;entities[id]=craft=Crafty(id);if(arguments.length>0){craft.addComponent.apply(craft,arguments)}craft.setName("Entity #"+id);craft.addComponent("obj");Crafty.trigger("NewEntity",{id:id});return craft},c:function(compName,component){components[compName]=component},trigger:function(event,data){var hdl=handlers[event],h,i,l;for(h in hdl){if(!hdl.hasOwnProperty(h))continue;for(i=0,l=hdl[h].length;i<l;i++){if(hdl[h]&&hdl[h][i]){if(entities[h]){hdl[h][i].call(Crafty(+h),data)}else{hdl[h][i].call(Crafty,data)}}}}},bind:function(event,callback){if(!handlers[event])handlers[event]={};var hdl=handlers[event];if(!hdl.global)hdl.global=[];return hdl.global.push(callback)-1},unbind:function(event,callback){var hdl=handlers[event],i,l,global_callbacks,found_match;if(hdl===undefined||hdl["global"]===undefined||hdl["global"].length===0){return false}if(arguments.length===1){delete hdl["global"];return true}global_callbacks=hdl["global"];found_match=false;for(i=0,l=global_callbacks.length;i<l;i++){if(global_callbacks[i]===callback){found_match=true;global_callbacks.splice(i,1);i--}}return found_match},frame:function(){return frame},components:function(){return components},isComp:function(comp){return comp in components},debug:function(){return entities},settings:function(){var states={},callbacks={};return{register:function(setting,callback){callbacks[setting]=callback},modify:function(setting,value){if(!callbacks[setting])return;callbacks[setting].call(states[setting],value);states[setting]=value},get:function(setting){return states[setting]}}}(),clone:clone});function UID(){var id=GUID++;if(id in entities){return UID()}return id}function clone(obj){if(obj===null||typeof obj!="object")return obj;var temp=obj.constructor();for(var key in obj)temp[key]=clone(obj[key]);return temp}Crafty.bind("Load",function(){if(!Crafty.support.setter&&Crafty.support.defineProperty){noSetter=[];Crafty.bind("EnterFrame",function(){var i=0,l=noSetter.length,current;for(;i<l;++i){current=noSetter[i];if(current.obj[current.prop]!==current.obj["_"+current.prop]){current.fn.call(current.obj,current.obj[current.prop])}}})}});initComponents(Crafty,window,window.document);window.Crafty=Crafty;if(typeof define==="function"){define("crafty",[],function(){return Crafty})}}(window,function(Crafty,window,document){!function(parent){var cellsize,HashMap=function(cell){cellsize=cell||64;this.map={}},SPACE=" ",keyHolder={};HashMap.prototype={insert:function(obj){var keys=HashMap.key(obj),entry=new Entry(keys,obj,this),i=0,j,hash;for(i=keys.x1;i<=keys.x2;i++){for(j=keys.y1;j<=keys.y2;j++){hash=i<<16^j;if(!this.map[hash])this.map[hash]=[];this.map[hash].push(obj)}}return entry},search:function(rect,filter){var keys=HashMap.key(rect,keyHolder),i,j,k,results=[];if(filter===undefined)filter=true;for(i=keys.x1;i<=keys.x2;i++){for(j=keys.y1;j<=keys.y2;j++){cell=this.map[i<<16^j];if(cell){for(k=0;k<cell.length;k++)results.push(cell[k])}}}if(filter){var obj,id,finalresult=[],found={};for(i=0,l=results.length;i<l;i++){obj=results[i];if(!obj)continue;id=obj[0];if(!found[id]&&obj.x<rect._x+rect._w&&obj._x+obj._w>rect._x&&obj.y<rect._y+rect._h&&obj._h+obj._y>rect._y)found[id]=results[i]}for(obj in found)finalresult.push(found[obj]);return finalresult}else{return results}},remove:function(keys,obj){var i=0,j,hash;if(arguments.length==1){obj=keys;keys=HashMap.key(obj,keyHolder)}for(i=keys.x1;i<=keys.x2;i++){for(j=keys.y1;j<=keys.y2;j++){hash=i<<16^j;if(this.map[hash]){var cell=this.map[hash],m,n=cell.length;for(m=0;m<n;m++)if(cell[m]&&cell[m][0]===obj[0])cell.splice(m,1)}}}},refresh:function(entry){var keys=entry.keys;var obj=entry.obj;var cell,i,j,m,n;for(i=keys.x1;i<=keys.x2;i++){for(j=keys.y1;j<=keys.y2;j++){cell=this.map[i<<16^j];if(cell){n=cell.length;for(m=0;m<n;m++)if(cell[m]&&cell[m][0]===obj[0])cell.splice(m,1)}}}HashMap.key(obj,keys);for(i=keys.x1;i<=keys.x2;i++){for(j=keys.y1;j<=keys.y2;j++){cell=this.map[i<<16^j];if(!cell)cell=this.map[i<<16^j]=[];cell.push(obj)}}return entry},boundaries:function(){var k,ent,hash={max:{x:-Infinity,y:-Infinity},min:{x:Infinity,y:Infinity}},coords={max:{x:-Infinity,y:-Infinity},min:{x:Infinity,y:Infinity}};for(var h in this.map){if(!this.map[h].length)continue;var i=h>>16,j=h<<16>>16;if(j<0){i=i^-1}if(i>=hash.max.x){hash.max.x=i;for(k in this.map[h]){ent=this.map[h][k];if(typeof ent=="object"&&"requires"in ent){coords.max.x=Math.max(coords.max.x,ent.x+ent.w)}}}if(i<=hash.min.x){hash.min.x=i;for(k in this.map[h]){ent=this.map[h][k];if(typeof ent=="object"&&"requires"in ent){coords.min.x=Math.min(coords.min.x,ent.x)}}}if(j>=hash.max.y){hash.max.y=j;for(k in this.map[h]){ent=this.map[h][k];if(typeof ent=="object"&&"requires"in ent){coords.max.y=Math.max(coords.max.y,ent.y+ent.h)}}}if(j<=hash.min.y){hash.min.y=j;for(k in this.map[h]){ent=this.map[h][k];if(typeof ent=="object"&&"requires"in ent){coords.min.y=Math.min(coords.min.y,ent.y)}}}}return coords}};HashMap.key=function(obj,keys){if(obj._mbr){obj=obj._mbr}if(!keys){keys={}}keys.x1=Math.floor(obj._x/cellsize);keys.y1=Math.floor(obj._y/cellsize);keys.x2=Math.floor((obj._w+obj._x)/cellsize);keys.y2=Math.floor((obj._h+obj._y)/cellsize);return keys};HashMap.hash=function(keys){return keys.x1+SPACE+keys.y1+SPACE+keys.x2+SPACE+keys.y2};function Entry(keys,obj,map){this.keys=keys;this.map=map;this.obj=obj}Entry.prototype={update:function(rect){if(HashMap.hash(HashMap.key(rect,keyHolder))!=HashMap.hash(this.keys)){this.map.refresh(this)}}};parent.HashMap=HashMap}(Crafty);Crafty.map=new Crafty.HashMap;var M=Math,Mc=M.cos,Ms=M.sin,PI=M.PI,DEG_TO_RAD=PI/180;Crafty.c("2D",{_x:0,_y:0,_w:0,_h:0,_z:0,_rotation:0,_alpha:1,_visible:true,_globalZ:null,_origin:null,_mbr:null,_entry:null,_children:null,_parent:null,_changed:false,_defineGetterSetter_setter:function(){this.__defineSetter__("x",function(v){this._attr("_x",v)});this.__defineSetter__("y",function(v){this._attr("_y",v)});this.__defineSetter__("w",function(v){this._attr("_w",v)});this.__defineSetter__("h",function(v){this._attr("_h",v)});this.__defineSetter__("z",function(v){this._attr("_z",v)});this.__defineSetter__("rotation",function(v){this._attr("_rotation",v)});this.__defineSetter__("alpha",function(v){this._attr("_alpha",v)});this.__defineSetter__("visible",function(v){this._attr("_visible",v)});this.__defineGetter__("x",function(){return this._x});this.__defineGetter__("y",function(){return this._y});this.__defineGetter__("w",function(){return this._w});this.__defineGetter__("h",function(){return this._h});this.__defineGetter__("z",function(){return this._z});this.__defineGetter__("rotation",function(){return this._rotation});this.__defineGetter__("alpha",function(){return this._alpha});this.__defineGetter__("visible",function(){return this._visible});this.__defineGetter__("parent",function(){return this._parent});this.__defineGetter__("numChildren",function(){return this._children.length})},_defineGetterSetter_defineProperty:function(){Object.defineProperty(this,"x",{set:function(v){this._attr("_x",v)},get:function(){return this._x},configurable:true});Object.defineProperty(this,"y",{set:function(v){this._attr("_y",v)},get:function(){return this._y},configurable:true});Object.defineProperty(this,"w",{set:function(v){this._attr("_w",v)},get:function(){return this._w},configurable:true});Object.defineProperty(this,"h",{set:function(v){this._attr("_h",v)},get:function(){return this._h},configurable:true});Object.defineProperty(this,"z",{set:function(v){this._attr("_z",v)},get:function(){return this._z},configurable:true});Object.defineProperty(this,"rotation",{set:function(v){this._attr("_rotation",v)},get:function(){return this._rotation},configurable:true});Object.defineProperty(this,"alpha",{set:function(v){this._attr("_alpha",v)},get:function(){return this._alpha},configurable:true});Object.defineProperty(this,"visible",{set:function(v){this._attr("_visible",v)},get:function(){return this._visible},configurable:true})},_defineGetterSetter_fallback:function(){this.x=this._x;this.y=this._y;this.w=this._w;this.h=this._h;this.z=this._z;this.rotation=this._rotation;this.alpha=this._alpha;this.visible=this._visible;this.bind("EnterFrame",function(){if(this.x!==this._x||this.y!==this._y||this.w!==this._w||this.h!==this._h||this.z!==this._z||this.rotation!==this._rotation||this.alpha!==this._alpha||this.visible!==this._visible){var old=this.mbr()||this.pos();if(this.rotation!==this._rotation){this._rotate(this.rotation)}else{var mbr=this._mbr,moved=false;if(mbr){if(this.x!==this._x){mbr._x-=this.x-this._x;moved=true}else if(this.y!==this._y){mbr._y-=this.y-this._y;moved=true}else if(this.w!==this._w){mbr._w-=this.w-this._w;moved=true}else if(this.h!==this._h){mbr._h-=this.h-this._h;moved=true}else if(this.z!==this._z){mbr._z-=this.z-this._z;moved=true}}if(moved)this.trigger("Move",old)}this._x=this.x;this._y=this.y;this._w=this.w;this._h=this.h;this._z=this.z;this._rotation=this.rotation;this._alpha=this.alpha;this._visible=this.visible;this.trigger("Change",old);this.trigger("Move",old)}})},init:function(){this._globalZ=this[0];this._origin={x:0,y:0};this._children=[];if(Crafty.support.setter){this._defineGetterSetter_setter()}else if(Crafty.support.defineProperty){this._defineGetterSetter_defineProperty()}else{this._defineGetterSetter_fallback()}this._entry=Crafty.map.insert(this);this.bind("Move",function(e){var area=this._mbr||this;this._entry.update(area);this._cascade(e)});this.bind("Rotate",function(e){var old=this._mbr||this;this._entry.update(old);this._cascade(e)});this.bind("Remove",function(){if(this._children){for(var i=0;i<this._children.length;i++){delete this._children[i]._parent;if(this._children[i].destroy){this._children[i].destroy()}}this._children=[]}if(this._parent){this._parent.detach(this)}Crafty.map.remove(this);this.detach()})},_rotate:function(v){var theta=-1*(v%360),rad=theta*DEG_TO_RAD,ct=Math.cos(rad),st=Math.sin(rad),o={x:this._origin.x+this._x,y:this._origin.y+this._y};if(!theta){this._mbr=null;if(!this._rotation%360)return}var x0=o.x+(this._x-o.x)*ct+(this._y-o.y)*st,y0=o.y-(this._x-o.x)*st+(this._y-o.y)*ct,x1=o.x+(this._x+this._w-o.x)*ct+(this._y-o.y)*st,y1=o.y-(this._x+this._w-o.x)*st+(this._y-o.y)*ct,x2=o.x+(this._x+this._w-o.x)*ct+(this._y+this._h-o.y)*st,y2=o.y-(this._x+this._w-o.x)*st+(this._y+this._h-o.y)*ct,x3=o.x+(this._x-o.x)*ct+(this._y+this._h-o.y)*st,y3=o.y-(this._x-o.x)*st+(this._y+this._h-o.y)*ct,minx=Math.floor(Math.min(x0,x1,x2,x3)),miny=Math.floor(Math.min(y0,y1,y2,y3)),maxx=Math.ceil(Math.max(x0,x1,x2,x3)),maxy=Math.ceil(Math.max(y0,y1,y2,y3));this._mbr={_x:minx,_y:miny,_w:maxx-minx,_h:maxy-miny};var difference=this._rotation-v,drad=difference*DEG_TO_RAD;this.trigger("Rotate",{cos:Math.cos(drad),sin:Math.sin(drad),deg:difference,rad:drad,o:{x:o.x,y:o.y},matrix:{M11:ct,M12:st,M21:-st,M22:ct}})},area:function(){return this._w*this._h},intersect:function(x,y,w,h){var rect,obj=this._mbr||this;if(typeof x==="object"){rect=x}else{rect={x:x,y:y,w:w,h:h}}return obj._x<rect.x+rect.w&&obj._x+obj._w>rect.x&&obj._y<rect.y+rect.h&&obj._h+obj._y>rect.y},within:function(x,y,w,h){var rect;if(typeof x==="object"){rect=x}else{rect={x:x,y:y,w:w,h:h}}return rect.x<=this.x&&rect.x+rect.w>=this.x+this.w&&rect.y<=this.y&&rect.y+rect.h>=this.y+this.h},contains:function(x,y,w,h){var rect;if(typeof x==="object"){rect=x}else{rect={x:x,y:y,w:w,h:h}}return rect.x>=this.x&&rect.x+rect.w<=this.x+this.w&&rect.y>=this.y&&rect.y+rect.h<=this.y+this.h},pos:function(){return{_x:this._x,_y:this._y,_w:this._w,_h:this._h}},mbr:function(){if(!this._mbr)return this.pos();return{_x:this._mbr._x,_y:this._mbr._y,_w:this._mbr._w,_h:this._mbr._h}},isAt:function(x,y){if(this.mapArea){return this.mapArea.containsPoint(x,y)}else if(this.map){return this.map.containsPoint(x,y)}return this.x<=x&&this.x+this.w>=x&&this.y<=y&&this.y+this.h>=y},move:function(dir,by){if(dir.charAt(0)==="n")this.y-=by;if(dir.charAt(0)==="s")this.y+=by;if(dir==="e"||dir.charAt(1)==="e")this.x+=by;if(dir==="w"||dir.charAt(1)==="w")this.x-=by;return this},shift:function(x,y,w,h){if(x)this.x+=x;if(y)this.y+=y;if(w)this.w+=w;if(h)this.h+=h;return this},_cascade:function(e){if(!e)return;var i=0,children=this._children,l=children.length,obj;if(e.cos){for(;i<l;++i){obj=children[i];if("rotate"in obj)obj.rotate(e)}}else{var rect=this._mbr||this,dx=rect._x-e._x,dy=rect._y-e._y,dw=rect._w-e._w,dh=rect._h-e._h;for(;i<l;++i){obj=children[i];obj.shift(dx,dy,dw,dh)}}},attach:function(){var i=0,arg=arguments,l=arguments.length,obj;for(;i<l;++i){obj=arg[i];if(obj._parent){obj._parent.detach(obj)}obj._parent=this;this._children.push(obj)}return this},detach:function(obj){if(!obj){for(var i=0;i<this._children.length;i++){this._children[i]._parent=null}this._children=[];return this}for(var i=0;i<this._children.length;i++){if(this._children[i]==obj){this._children.splice(i,1)}}obj._parent=null;return this},origin:function(x,y){if(typeof x==="string"){if(x==="centre"||x==="center"||x.indexOf(" ")===-1){x=this._w/2;y=this._h/2}else{var cmd=x.split(" ");if(cmd[0]==="top")y=0;else if(cmd[0]==="bottom")y=this._h;else if(cmd[0]==="middle"||cmd[1]==="center"||cmd[1]==="centre")y=this._h/2;if(cmd[1]==="center"||cmd[1]==="centre"||cmd[1]==="middle")x=this._w/2;else if(cmd[1]==="left")x=0;else if(cmd[1]==="right")x=this._w}}this._origin.x=x;this._origin.y=y;return this},flip:function(dir){dir=dir||"X";if(!this["_flip"+dir]){this["_flip"+dir]=true;this.trigger("Change")}},unflip:function(dir){dir=dir||"X";if(this["_flip"+dir]){this["_flip"+dir]=false;this.trigger("Change")}},rotate:function(e){this._origin.x=e.o.x-this._x;this._origin.y=e.o.y-this._y;this._attr("_rotation",this._rotation-e.deg)},_attr:function(name,value){if(this[name]===value){return}var pos=this.pos(),old=this.mbr()||pos;if(name==="_rotation"){this._rotate(value);this.trigger("Rotate")}else if(name==="_z"){this._globalZ=parseInt(value+Crafty.zeroFill(this[0],5),10);this.trigger("reorder")}else if(name=="_x"||name==="_y"||name==="_w"||name==="_h"){var mbr=this._mbr;if(mbr){mbr[name]-=this[name]-value}this[name]=value;this.trigger("Move",old)}this[name]=value;this.trigger("Change",old)}});Crafty.c("Physics",{_gravity:.4,_friction:.2,_bounce:.5,gravity:function(gravity){this._gravity=gravity}});Crafty.c("Gravity",{_gravityConst:.2,_gy:0,_falling:true,_anti:null,init:function(){this.requires("2D")},gravity:function(comp){if(comp)this._anti=comp;this.bind("EnterFrame",this._enterFrame);return this},gravityConst:function(g){this._gravityConst=g;return this},_enterFrame:function(){if(this._falling){this._gy+=this._gravityConst;this.y+=this._gy}else{this._gy=0}var obj,hit=false,pos=this.pos(),q,i=0,l;pos._y++;pos.x=pos._x;pos.y=pos._y;pos.w=pos._w;pos.h=pos._h;q=Crafty.map.search(pos);l=q.length;for(;i<l;++i){obj=q[i];if(obj!==this&&obj.has(this._anti)&&obj.intersect(pos)){hit=obj;break}}if(hit){if(this._falling)this.stopFalling(hit)}else{this._falling=true}},stopFalling:function(e){if(e)this.y=e._y-this._h;this._falling=false;if(this._up)this._up=false;this.trigger("hit")},antigravity:function(){this.unbind("EnterFrame",this._enterFrame)}});Crafty.polygon=function(poly){if(arguments.length>1){poly=Array.prototype.slice.call(arguments,0)}this.points=poly};Crafty.polygon.prototype={containsPoint:function(x,y){var p=this.points,i,j,c=false;for(i=0,j=p.length-1;i<p.length;j=i++){if(p[i][1]>y!=p[j][1]>y&&x<(p[j][0]-p[i][0])*(y-p[i][1])/(p[j][1]-p[i][1])+p[i][0]){c=!c}}return c},shift:function(x,y){var i=0,l=this.points.length,current;for(;i<l;i++){current=this.points[i];current[0]+=x;current[1]+=y}},rotate:function(e){var i=0,l=this.points.length,current,x,y;for(;i<l;i++){current=this.points[i];x=e.o.x+(current[0]-e.o.x)*e.cos+(current[1]-e.o.y)*e.sin;y=e.o.y-(current[0]-e.o.x)*e.sin+(current[1]-e.o.y)*e.cos;current[0]=x;current[1]=y}}};Crafty.circle=function(x,y,radius){this.x=x;this.y=y;this.radius=radius;this.points=[];var theta;for(var i=0;i<8;i++){theta=i*Math.PI/4;this.points[i]=[this.x+Math.sin(theta)*radius,this.y+Math.cos(theta)*radius]}};Crafty.circle.prototype={containsPoint:function(x,y){var radius=this.radius,sqrt=Math.sqrt,deltaX=this.x-x,deltaY=this.y-y;return deltaX*deltaX+deltaY*deltaY<radius*radius},shift:function(x,y){this.x+=x;this.y+=y;var i=0,l=this.points.length,current;for(;i<l;i++){current=this.points[i];current[0]+=x;current[1]+=y}},rotate:function(){}};Crafty.matrix=function(m){this.mtx=m;this.width=m[0].length;this.height=m.length};Crafty.matrix.prototype={x:function(other){if(this.width!=other.height){return}var result=[];for(var i=0;i<this.height;i++){result[i]=[];for(var j=0;j<other.width;j++){var sum=0;for(var k=0;k<this.width;k++){sum+=this.mtx[i][k]*other.mtx[k][j]}result[i][j]=sum}}return new Crafty.matrix(result)},e:function(row,col){if(row<1||row>this.mtx.length||col<1||col>this.mtx[0].length)return null;return this.mtx[row-1][col-1]}};Crafty.c("Collision",{init:function(){this.requires("2D");var area=this._mbr||this;var poly=new Crafty.polygon([0,0],[area._w,0],[area._w,area._h],[0,area._h]);this.map=poly;this.attach(this.map);this.map.shift(area._x,area._y)},collision:function(poly){var area=this._mbr||this;if(!poly){poly=new Crafty.polygon([0,0],[area._w,0],[area._w,area._h],[0,area._h])}if(arguments.length>1){var args=Array.prototype.slice.call(arguments,0);poly=new Crafty.polygon(args)}this.map=poly;this.attach(this.map);this.map.shift(area._x,area._y);return this},hit:function(comp){var area=this._mbr||this,results=Crafty.map.search(area,false),i=0,l=results.length,dupes={},id,obj,oarea,key,hasMap="map"in this&&"containsPoint"in this.map,finalresult=[];if(!l){return false}for(;i<l;++i){obj=results[i];oarea=obj._mbr||obj;if(!obj)continue;id=obj[0];if(!dupes[id]&&this[0]!==id&&obj.__c[comp]&&oarea._x<area._x+area._w&&oarea._x+oarea._w>area._x&&oarea._y<area._y+area._h&&oarea._h+oarea._y>area._y)dupes[id]=obj}for(key in dupes){obj=dupes[key];if(hasMap&&"map"in obj){var SAT=this._SAT(this.map,obj.map);SAT.obj=obj;SAT.type="SAT";if(SAT)finalresult.push(SAT)}else{finalresult.push({obj:obj,type:"MBR"})}}if(!finalresult.length){return false}return finalresult},onHit:function(comp,callback,callbackOff){var justHit=false;this.bind("EnterFrame",function(){var hitdata=this.hit(comp);if(hitdata){justHit=true;callback.call(this,hitdata)}else if(justHit){if(typeof callbackOff=="function"){callbackOff.call(this)}justHit=false}});return this},_SAT:function(poly1,poly2){var points1=poly1.points,points2=poly2.points,i=0,l=points1.length,j,k=points2.length,normal={x:0,y:0},length,min1,min2,max1,max2,interval,MTV=null,MTV2=null,MN=null,dot,nextPoint,currentPoint;for(;i<l;i++){nextPoint=points1[i==l-1?0:i+1];currentPoint=points1[i];normal.x=-(nextPoint[1]-currentPoint[1]);normal.y=nextPoint[0]-currentPoint[0];length=Math.sqrt(normal.x*normal.x+normal.y*normal.y);normal.x/=length;normal.y/=length;min1=min2=-1;max1=max2=-1;for(j=0;j<l;++j){dot=points1[j][0]*normal.x+points1[j][1]*normal.y;if(dot>max1||max1===-1)max1=dot;if(dot<min1||min1===-1)min1=dot}for(j=0;j<k;++j){dot=points2[j][0]*normal.x+points2[j][1]*normal.y;if(dot>max2||max2===-1)max2=dot;if(dot<min2||min2===-1)min2=dot}if(min1<min2){interval=min2-max1;normal.x=-normal.x;normal.y=-normal.y}else{interval=min1-max2}if(interval>=0){return false}if(MTV===null||interval>MTV){MTV=interval;MN={x:normal.x,y:normal.y}}}for(i=0;i<k;i++){nextPoint=points2[i==k-1?0:i+1];currentPoint=points2[i];normal.x=-(nextPoint[1]-currentPoint[1]);normal.y=nextPoint[0]-currentPoint[0];length=Math.sqrt(normal.x*normal.x+normal.y*normal.y);normal.x/=length;normal.y/=length;min1=min2=-1;max1=max2=-1;for(j=0;j<l;++j){dot=points1[j][0]*normal.x+points1[j][1]*normal.y;if(dot>max1||max1===-1)max1=dot;if(dot<min1||min1===-1)min1=dot}for(j=0;j<k;++j){dot=points2[j][0]*normal.x+points2[j][1]*normal.y;if(dot>max2||max2===-1)max2=dot;if(dot<min2||min2===-1)min2=dot}if(min1<min2){interval=min2-max1;normal.x=-normal.x;normal.y=-normal.y}else{interval=min1-max2}if(interval>=0){return false}if(MTV===null||interval>MTV)MTV=interval;if(interval>MTV2||MTV2===null){MTV2=interval;MN={x:normal.x,y:normal.y}}}return{overlap:MTV2,normal:MN}}});Crafty.c("WiredHitBox",{init:function(){if(Crafty.support.canvas){var c=document.getElementById("HitBox");if(!c){c=document.createElement("canvas");c.id="HitBox";c.width=Crafty.viewport.width;c.height=Crafty.viewport.height;c.style.position="absolute";c.style.left="0px";c.style.top="0px";c.style.zIndex="1000";Crafty.stage.elem.appendChild(c)}var ctx=c.getContext("2d");var drawed=0,total=Crafty("WiredHitBox").length;var drawBoxFunction=function(){if(drawed==total){ctx.clearRect(0,0,Crafty.viewport.width,Crafty.viewport.height);drawed=0}ctx.beginPath();for(var p in this.map.points){ctx.lineTo(Crafty.viewport.x+this.map.points[p][0],Crafty.viewport.y+this.map.points[p][1])}ctx.closePath();ctx.stroke();drawed++};this.requires("Collision").bind("EnterFrame",drawBoxFunction);this.bind("RemoveComponent",function(c){if(c=="WiredHitBox"){this.unbind("EnterFrame",drawBoxFunction);if(drawed==total){ctx.clearRect(0,0,Crafty.viewport.width,Crafty.viewport.height);drawed=0}}})}return this}});Crafty.c("SolidHitBox",{init:function(){if(Crafty.support.canvas){var c=document.getElementById("HitBox");if(!c){c=document.createElement("canvas");c.id="HitBox";c.width=Crafty.viewport.width;c.height=Crafty.viewport.height;c.style.position="absolute";c.style.left="0px";c.style.top="0px";c.style.zIndex="1000";Crafty.stage.elem.appendChild(c)}var ctx=c.getContext("2d");var drawed=0,total=Crafty("SolidHitBox").length;var drawBoxFunction=function(){if(drawed==total){ctx.clearRect(0,0,Crafty.viewport.width,Crafty.viewport.height);drawed=0}ctx.beginPath();for(var p in this.map.points){ctx.lineTo(Crafty.viewport.x+this.map.points[p][0],Crafty.viewport.y+this.map.points[p][1])}ctx.closePath();ctx.fill();drawed++};this.requires("Collision").bind("EnterFrame",drawBoxFunction);this.bind("RemoveComponent",function(c){if(c=="SolidHitBox"){this.unbind("EnterFrame",drawBoxFunction);if(drawed==total){ctx.clearRect(0,0,Crafty.viewport.width,Crafty.viewport.height);drawed=0}}})}return this}});Crafty.c("DOM",{_element:null,_cssStyles:null,init:function(){this._cssStyles={visibility:"",left:"",top:"",width:"",height:"",zIndex:"",opacity:"",transformOrigin:"",transform:""};this._element=document.createElement("div");Crafty.stage.inner.appendChild(this._element);this._element.style.position="absolute";this._element.id="ent"+this[0];this.bind("Change",function(){if(!this._changed){this._changed=true;Crafty.DrawManager.addDom(this)}});function updateClass(){var i=0,c=this.__c,str="";for(i in c){str+=" "+i}str=str.substr(1);this._element.className=str}this.bind("NewComponent",updateClass).bind("RemoveComponent",updateClass);if(Crafty.support.prefix==="ms"&&Crafty.support.version<9){this._filters={};this.bind("Rotate",function(e){var m=e.matrix,elem=this._element.style,M11=m.M11.toFixed(8),M12=m.M12.toFixed(8),M21=m.M21.toFixed(8),M22=m.M22.toFixed(8);this._filters.rotation="progid:DXImageTransform.Microsoft.Matrix(M11="+M11+", M12="+M12+", M21="+M21+", M22="+M22+",sizingMethod='auto expand')"})}this.bind("Remove",this.undraw);this.bind("RemoveComponent",function(compName){if(compName==="DOM")this.undraw()})},getDomId:function(){return this._element.id},DOM:function(elem){if(elem&&elem.nodeType){this.undraw();this._element=elem;this._element.style.position="absolute"}return this},draw:function(){var style=this._element.style,coord=this.__coord||[0,0,0,0],co={x:coord[0],y:coord[1]},prefix=Crafty.support.prefix,trans=[];if(this._cssStyles.visibility!==this._visible){this._cssStyles.visibility=this._visible;if(!this._visible){style.visibility="hidden"}else{style.visibility="visible"}}if(Crafty.support.css3dtransform){trans.push("translate3d("+~~this._x+"px,"+~~this._y+"px,0)")}else{if(this._cssStyles.left!==this._x){this._cssStyles.left=this._x;style.left=~~this._x+"px"}if(this._cssStyles.top!==this._y){this._cssStyles.top=this._y;style.top=~~this._y+"px"}}if(this._cssStyles.width!==this._w){this._cssStyles.width=this._w;style.width=~~this._w+"px"}if(this._cssStyles.height!==this._h){this._cssStyles.height=this._h;
style.height=~~this._h+"px"}if(this._cssStyles.zIndex!==this._z){this._cssStyles.zIndex=this._z;style.zIndex=this._z}if(this._cssStyles.opacity!==this._alpha){this._cssStyles.opacity=this._alpha;style.opacity=this._alpha;style[prefix+"Opacity"]=this._alpha}if(prefix==="ms"&&Crafty.support.version<9){if(Crafty.support.version===8){this._filters.alpha="progid:DXImageTransform.Microsoft.Alpha(Opacity="+this._alpha*100+")"}else{this._filters.alpha="alpha(opacity="+this._alpha*100+")"}}if(this._mbr){var origin=this._origin.x+"px "+this._origin.y+"px";style.transformOrigin=origin;style[prefix+"TransformOrigin"]=origin;if(Crafty.support.css3dtransform)trans.push("rotateZ("+this._rotation+"deg)");else trans.push("rotate("+this._rotation+"deg)")}if(this._flipX){trans.push("scaleX(-1)");if(prefix==="ms"&&Crafty.support.version<9){this._filters.flipX="fliph"}}if(this._flipY){trans.push("scaleY(-1)");if(prefix==="ms"&&Crafty.support.version<9){this._filters.flipY="flipv"}}if(prefix==="ms"&&Crafty.support.version<9){this.applyFilters()}if(this._cssStyles.transform!=trans.join(" ")){this._cssStyles.transform=trans.join(" ");style.transform=this._cssStyles.transform;style[prefix+"Transform"]=this._cssStyles.transform}this.trigger("Draw",{style:style,type:"DOM",co:co});return this},applyFilters:function(){this._element.style.filter="";var str="";for(var filter in this._filters){if(!this._filters.hasOwnProperty(filter))continue;str+=this._filters[filter]+" "}this._element.style.filter=str},undraw:function(){if(this._element){Crafty.stage.inner.removeChild(this._element)}return this},css:function(obj,value){var key,elem=this._element,val,style=elem.style;if(typeof obj==="object"){for(key in obj){if(!obj.hasOwnProperty(key))continue;val=obj[key];if(typeof val==="number")val+="px";style[Crafty.DOM.camelize(key)]=val}}else{if(value){if(typeof value==="number")value+="px";style[Crafty.DOM.camelize(obj)]=value}else{return Crafty.DOM.getStyle(elem,obj)}}this.trigger("Change");return this}});try{document.execCommand("BackgroundImageCache",false,true)}catch(e){}Crafty.extend({DOM:{window:{init:function(){this.width=window.innerWidth||window.document.documentElement.clientWidth||window.document.body.clientWidth;this.height=window.innerHeight||window.document.documentElement.clientHeight||window.document.body.clientHeight},width:0,height:0},inner:function(obj){var rect=obj.getBoundingClientRect(),x=rect.left+(window.pageXOffset?window.pageXOffset:document.body.scrollLeft),y=rect.top+(window.pageYOffset?window.pageYOffset:document.body.scrollTop),borderX=parseInt(this.getStyle(obj,"border-left-width")||0,10)||parseInt(this.getStyle(obj,"borderLeftWidth")||0,10)||0,borderY=parseInt(this.getStyle(obj,"border-top-width")||0,10)||parseInt(this.getStyle(obj,"borderTopWidth")||0,10)||0;x+=borderX;y+=borderY;return{x:x,y:y}},getStyle:function(obj,prop){var result;if(obj.currentStyle)result=obj.currentStyle[this.camelize(prop)];else if(window.getComputedStyle)result=document.defaultView.getComputedStyle(obj,null).getPropertyValue(this.csselize(prop));return result},camelize:function(str){return str.replace(/-+(.)?/g,function(match,chr){return chr?chr.toUpperCase():""})},csselize:function(str){return str.replace(/[A-Z]/g,function(chr){return chr?"-"+chr.toLowerCase():""})},translate:function(x,y){return{x:(x-Crafty.stage.x+document.body.scrollLeft+document.documentElement.scrollLeft-Crafty.viewport._x)/Crafty.viewport._zoom,y:(y-Crafty.stage.y+document.body.scrollTop+document.documentElement.scrollTop-Crafty.viewport._y)/Crafty.viewport._zoom}}}});Crafty.c("FPS",{values:[],maxValues:60,init:function(){this.bind("MessureFPS",function(fps){if(this.values.length>this.maxValues)this.values.splice(0,1);this.values.push(fps.value)})}});Crafty.c("HTML",{inner:"",init:function(){this.requires("2D, DOM")},replace:function(new_html){this.inner=new_html;this._element.innerHTML=new_html;return this},append:function(new_html){this.inner+=new_html;this._element.innerHTML+=new_html;return this},prepend:function(new_html){this.inner=new_html+this.inner;this._element.innerHTML=new_html+this.inner;return this}});Crafty.storage=function(){var db=null,url,gameName,timestamps={},transactionType={READ:"readonly",READ_WRITE:"readwrite"};function process(obj){if(obj.c){var d=Crafty.e(obj.c).attr(obj.attr).trigger("LoadData",obj,process);return d}else if(typeof obj=="object"){for(var prop in obj){obj[prop]=process(obj[prop])}}return obj}function unserialize(str){if(typeof str!="string")return null;var data=JSON?JSON.parse(str):eval("("+str+")");return process(data)}function prep(obj){if(obj.__c){var data={c:[],attr:{}};obj.trigger("SaveData",data,prep);for(var i in obj.__c){data.c.push(i)}data.c=data.c.join(", ");obj=data}else if(typeof obj=="object"){for(var prop in obj){obj[prop]=prep(obj[prop])}}return obj}function serialize(e){if(JSON){var data=prep(e);return JSON.stringify(data)}else{alert("Crafty does not support saving on your browser. Please upgrade to a newer browser.");return false}}function external(setUrl){url=setUrl}function openExternal(){if(1&&typeof url=="undefined")return;var xml=new XMLHttpRequest;xhr.open("POST",url);xhr.onreadystatechange=function(evt){if(xhr.readyState==4){if(xhr.status==200){var data=eval("("+xhr.responseText+")");for(var i in data){if(Crafty.storage.check(data[i].key,data[i].timestamp)){loadExternal(data[i].key)}}}}};xhr.send("mode=timestamps&game="+gameName)}function saveExternal(key,data,ts){if(1&&typeof url=="undefined")return;var xhr=new XMLHttpRequest;xhr.open("POST",url);xhr.send("mode=save&key="+key+"&data="+encodeURIComponent(data)+"&ts="+ts+"&game="+gameName)}function loadExternal(key){if(1&&typeof url=="undefined")return;var xhr=new XMLHttpRequest;xhr.open("POST",url);xhr.onreadystatechange=function(evt){if(xhr.readyState==4){if(xhr.status==200){var data=eval("("+xhr.responseText+")");Crafty.storage.save(key,"save",data)}}};xhr.send("mode=load&key="+key+"&game="+gameName)}function ts(){var d=new Date;return d.getTime()}if(typeof indexedDB!="object"){window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction;window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;if(typeof IDBTransaction=="object"){transactionType.READ=IDBTransaction.READ||IDBTransaction.readonly||transactionType.READ||"read";transactionType.READ_WRITE=IDBTransaction.READ_WRITE||IDBTransaction.readwrite||transactionType.READ_WRITE||"readwrite"}}if(typeof indexedDB=="object"){return{open:function(gameName_n){gameName=gameName_n;var stores=[];if(arguments.length==1){stores.push("save");stores.push("cache")}else{stores=arguments;stores.shift();stores.push("save");stores.push("cache")}if(db==null){var request=indexedDB.open(gameName);request.onsuccess=function(e){db=e.target.result;getTimestamps();openExternal()};request.onupgradeneeded=function(e){createStores()}}else{createStores();getTimestamps();openExternal()}function getTimestamps(){try{var trans=db.transaction(["save"],"read"),store=trans.objectStore("save"),request=store.getAll();request.onsuccess=function(e){var i=0,a=event.target.result,l=a.length;for(;i<l;i++){timestamps[a[i].key]=a[i].timestamp}}}catch(e){}}function createStores(){var request=db.setVersion("1.0");request.onsuccess=function(e){for(var i=0;i<stores.length;i++){var st=stores[i];if(db.objectStoreNames.contains(st))continue;var store=db.createObjectStore(st,{keyPath:"key"})}}}},save:function(key,type,data,callback){if(db==null){setTimeout(function(){Crafty.storage.save(key,type,data)},1);return}var str=serialize(data),t=ts();if(type=="save")saveExternal(key,str,t);try{var request=db.transaction([type],transactionType.READ_WRITE).objectStore(type).add({data:str,timestamp:t,key:key});if(typeof callback=="function"){request.onsuccess=callback}}catch(e){console.error(e)}},load:function(key,type,callback){if(db==null){setTimeout(function(){Crafty.storage.load(key,type,callback)},1);return}try{var request=db.transaction([type],transactionType.READ).objectStore(type).get(key);request.onsuccess=function(e){callback(unserialize(e.target.result.data))}}catch(e){console.error(e)}},getAllKeys:function(type,callback){if(db==null){setTimeout(function(){Crafty.storage.getAllkeys(type,callback)},1)}try{var request=db.transaction([type],transactionType.READ).objectStore(type).openCursor(),res=[];request.onsuccess=function(e){var cursor=e.target.result;if(cursor){res.push(cursor.key);cursor["continue"]()}else{callback(res)}}}catch(e){console.error(e)}},check:function(key,timestamp){return timestamps[key]>timestamp},external:external}}else if(typeof openDatabase=="function"){return{open:function(gameName_n){gameName=gameName_n;if(arguments.length==1){db={save:openDatabase(gameName_n+"_save","1.0","Saves games for "+gameName_n,5*1024*1024),cache:openDatabase(gameName_n+"_cache","1.0","Cache for "+gameName_n,5*1024*1024)}}else{var args=arguments,i=0;args.shift();for(;i<args.length;i++){if(typeof db[args[i]]=="undefined")db[args[i]]=openDatabase(gameName+"_"+args[i],"1.0",type,5*1024*1024)}}db["save"].transaction(function(tx){tx.executeSql("SELECT key, timestamp FROM data",[],function(tx,res){var i=0,a=res.rows,l=a.length;for(;i<l;i++){timestamps[a.item(i).key]=a.item(i).timestamp}})})},save:function(key,type,data){if(typeof db[type]=="undefined"&&gameName!=""){this.open(gameName,type)}var str=serialize(data),t=ts();if(type=="save")saveExternal(key,str,t);db[type].transaction(function(tx){tx.executeSql("CREATE TABLE IF NOT EXISTS data (key unique, text, timestamp)");tx.executeSql("SELECT * FROM data WHERE key = ?",[key],function(tx,results){if(results.rows.length){tx.executeSql("UPDATE data SET text = ?, timestamp = ? WHERE key = ?",[str,t,key])}else{tx.executeSql("INSERT INTO data VALUES (?, ?, ?)",[key,str,t])}})})},load:function(key,type,callback){if(db[type]==null){setTimeout(function(){Crafty.storage.load(key,type,callback)},1);return}db[type].transaction(function(tx){tx.executeSql("SELECT text FROM data WHERE key = ?",[key],function(tx,results){if(results.rows.length){res=unserialize(results.rows.item(0).text);callback(res)}})})},getAllKeys:function(type,callback){if(db[type]==null){setTimeout(function(){Crafty.storage.getAllKeys(type,callback)},1);return}db[type].transaction(function(tx){tx.executeSql("SELECT key FROM data",[],function(tx,results){callback(results.rows)})})},check:function(key,timestamp){return timestamps[key]>timestamp},external:external}}else if(typeof window.localStorage=="object"){return{open:function(gameName_n){gameName=gameName_n},save:function(key,type,data){var k=gameName+"."+type+"."+key,str=serialize(data),t=ts();if(type=="save")saveExternal(key,str,t);window.localStorage[k]=str;if(type=="save")window.localStorage[k+".ts"]=t},load:function(key,type,callback){var k=gameName+"."+type+"."+key,str=window.localStorage[k];callback(unserialize(str))},getAllKeys:function(type,callback){var res={},output=[],header=gameName+"."+type;for(var i in window.localStorage){if(i.indexOf(header)!=-1){var key=i.replace(header,"").replace(".ts","");res[key]=true}}for(i in res){output.push(i)}callback(output)},check:function(key,timestamp){var ts=window.localStorage[gameName+".save."+key+".ts"];return parseInt(timestamp)>parseInt(ts)},external:external}}else{return{open:function(gameName_n){gameName=gameName_n},save:function(key,type,data){if(type!="save")return;var str=serialize(data),t=ts();if(type=="save")saveExternal(key,str,t);document.cookie=gameName+"_"+key+"="+str+"; "+gameName+"_"+key+"_ts="+t+"; expires=Thur, 31 Dec 2099 23:59:59 UTC; path=/"},load:function(key,type,callback){if(type!="save")return;var reg=new RegExp(gameName+"_"+key+"=[^;]*"),result=reg.exec(document.cookie),data=unserialize(result[0].replace(gameName+"_"+key+"=",""));callback(data)},getAllKeys:function(type,callback){if(type!="save")return;var reg=new RegExp(gameName+"_[^_=]","g"),matches=reg.exec(document.cookie),i=0,l=matches.length,res={},output=[];for(;i<l;i++){var key=matches[i].replace(gameName+"_","");res[key]=true}for(i in res){output.push(i)}callback(output)},check:function(key,timestamp){var header=gameName+"_"+key+"_ts",reg=new RegExp(header+"=[^;]"),result=reg.exec(document.cookie),ts=result[0].replace(header+"=","");return parseInt(timestamp)>parseInt(ts)},external:external}}}();!function testSupport(){var support=Crafty.support={},ua=navigator.userAgent.toLowerCase(),match=/(webkit)[ \/]([\w.]+)/.exec(ua)||/(o)pera(?:.*version)?[ \/]([\w.]+)/.exec(ua)||/(ms)ie ([\w.]+)/.exec(ua)||/(moz)illa(?:.*? rv:([\w.]+))?/.exec(ua)||[],mobile=/iPad|iPod|iPhone|Android|webOS|IEMobile/i.exec(ua);if(mobile)Crafty.mobile=mobile[0];support.setter="__defineSetter__"in this&&"__defineGetter__"in this;support.defineProperty=function(){if(!"defineProperty"in Object)return false;try{Object.defineProperty({},"x",{})}catch(e){return false}return true}();support.audio="Audio"in window;support.prefix=match[1]||match[0];if(support.prefix==="moz")support.prefix="Moz";if(support.prefix==="o")support.prefix="O";if(match[2]){support.versionName=match[2];support.version=+match[2].split(".")[0]}support.canvas="getContext"in document.createElement("canvas");if(support.canvas){var gl;try{gl=document.createElement("canvas").getContext("experimental-webgl");gl.viewportWidth=support.canvas.width;gl.viewportHeight=support.canvas.height}catch(e){}support.webgl=!!gl}else{support.webgl=false}support.css3dtransform=typeof document.createElement("div").style["Perspective"]!=="undefined"||typeof document.createElement("div").style[support.prefix+"Perspective"]!=="undefined";support.deviceorientation=typeof window.DeviceOrientationEvent!=="undefined"||typeof window.OrientationEvent!=="undefined";support.devicemotion=typeof window.DeviceMotionEvent!=="undefined"}();Crafty.extend({zeroFill:function(number,width){width-=number.toString().length;if(width>0)return new Array(width+(/\./.test(number)?2:1)).join("0")+number;return number.toString()},sprite:function(tile,tileh,url,map,paddingX,paddingY){var spriteName,temp,x,y,w,h,img;if(typeof tile==="string"){paddingY=paddingX;paddingX=map;map=tileh;url=tile;tile=1;tileh=1}if(typeof tileh=="string"){paddingY=paddingX;paddingX=map;map=url;url=tileh;tileh=tile}if(!paddingY&&paddingX)paddingY=paddingX;paddingX=parseInt(paddingX||0,10);paddingY=parseInt(paddingY||0,10);img=Crafty.asset(url);if(!img){img=new Image;img.src=url;Crafty.asset(url,img);img.onload=function(){for(spriteName in map){Crafty(spriteName).each(function(){this.ready=true;this.trigger("Change")})}}}for(spriteName in map){if(!map.hasOwnProperty(spriteName))continue;temp=map[spriteName];x=temp[0]*(tile+paddingX);y=temp[1]*(tileh+paddingY);w=temp[2]*tile||tile;h=temp[3]*tileh||tileh;Crafty.c(spriteName,{ready:false,__coord:[x,y,w,h],init:function(){this.requires("Sprite");this.__trim=[0,0,0,0];this.__image=url;this.__coord=[this.__coord[0],this.__coord[1],this.__coord[2],this.__coord[3]];this.__tile=tile;this.__tileh=tileh;this.__padding=[paddingX,paddingY];this.img=img;if(this.img.complete&&this.img.width>0){this.ready=true;this.trigger("Change")}this.w=this.__coord[2];this.h=this.__coord[3]}})}return this},_events:{},addEvent:function(ctx,obj,type,callback){if(arguments.length===3){callback=type;type=obj;obj=window.document}var afn=function(e){var e=e||window.event;if(typeof callback==="function"){callback.call(ctx,e)}},id=ctx[0]||"";if(!this._events[id+obj+type+callback])this._events[id+obj+type+callback]=afn;else return;if(obj.attachEvent){obj.attachEvent("on"+type,afn)}else{obj.addEventListener(type,afn,false)}},removeEvent:function(ctx,obj,type,callback){if(arguments.length===3){callback=type;type=obj;obj=window.document}var id=ctx[0]||"",afn=this._events[id+obj+type+callback];if(afn){if(obj.detachEvent){obj.detachEvent("on"+type,afn)}else obj.removeEventListener(type,afn,false);delete this._events[id+obj+type+callback]}},background:function(style){Crafty.stage.elem.style.background=style},viewport:{clampToEntities:true,width:0,height:0,_x:0,_y:0,bounds:null,scroll:function(axis,v){v=Math.floor(v);var change=v-this[axis],context=Crafty.canvas.context,style=Crafty.stage.inner.style,canvas;this[axis]=v;if(context){if(axis=="_x"){context.translate(change,0)}else{context.translate(0,change)}Crafty.DrawManager.drawAll()}style[axis=="_x"?"left":"top"]=v+"px"},rect:function(){return{_x:-this._x,_y:-this._y,_w:this.width,_h:this.height}},pan:function(){var tweens={},i,bound=false;function enterFrame(e){var l=0;for(i in tweens){var prop=tweens[i];if(prop.remTime>0){prop.current+=prop.diff;prop.remTime--;Crafty.viewport[i]=Math.floor(prop.current);l++}else{delete tweens[i]}}if(l)Crafty.viewport._clamp()}return function(axis,v,time){Crafty.viewport.follow();if(axis=="reset"){for(i in tweens){tweens[i].remTime=0}return}if(time==0)time=1;tweens[axis]={diff:-v/time,current:Crafty.viewport[axis],remTime:time};if(!bound){Crafty.bind("EnterFrame",enterFrame);bound=true}}}(),follow:function(){var oldTarget,offx,offy;function change(){Crafty.viewport.scroll("_x",-(this.x+this.w/2-Crafty.viewport.width/2-offx));Crafty.viewport.scroll("_y",-(this.y+this.h/2-Crafty.viewport.height/2-offy));Crafty.viewport._clamp()}return function(target,offsetx,offsety){if(oldTarget)oldTarget.unbind("Change",change);if(!target||!target.has("2D"))return;Crafty.viewport.pan("reset");oldTarget=target;offx=typeof offsetx!="undefined"?offsetx:0;offy=typeof offsety!="undefined"?offsety:0;target.bind("Change",change);change.call(target)}}(),centerOn:function(targ,time){var x=targ.x,y=targ.y,mid_x=targ.w/2,mid_y=targ.h/2,cent_x=Crafty.viewport.width/2,cent_y=Crafty.viewport.height/2,new_x=x+mid_x-cent_x,new_y=y+mid_y-cent_y;Crafty.viewport.pan("reset");Crafty.viewport.pan("x",new_x,time);Crafty.viewport.pan("y",new_y,time)},_zoom:1,zoom:function(){var zoom=1,zoom_tick=0,dur=0,prop=Crafty.support.prefix+"Transform",bound=false,act={},prct={};function enterFrame(){if(dur>0){if(isFinite(Crafty.viewport._zoom))zoom=Crafty.viewport._zoom;var old={width:act.width*zoom,height:act.height*zoom};zoom+=zoom_tick;Crafty.viewport._zoom=zoom;var new_s={width:act.width*zoom,height:act.height*zoom},diff={width:new_s.width-old.width,height:new_s.height-old.height};Crafty.stage.inner.style[prop]="scale("+zoom+","+zoom+")";if(Crafty.canvas._canvas){var czoom=zoom/(zoom-zoom_tick);Crafty.canvas.context.scale(czoom,czoom);Crafty.DrawManager.drawAll()}Crafty.viewport.x-=diff.width*prct.width;Crafty.viewport.y-=diff.height*prct.height;dur--}}return function(amt,cent_x,cent_y,time){var bounds=this.bounds||Crafty.map.boundaries(),final_zoom=amt?zoom*amt:1;if(!amt){zoom=1;this._zoom=1}act.width=bounds.max.x-bounds.min.x;act.height=bounds.max.y-bounds.min.y;prct.width=cent_x/act.width;prct.height=cent_y/act.height;if(time==0)time=1;zoom_tick=(final_zoom-zoom)/time;dur=time;Crafty.viewport.pan("reset");if(!bound){Crafty.bind("EnterFrame",enterFrame);bound=true}}}(),scale:function(){var prop=Crafty.support.prefix+"Transform",act={};return function(amt){var bounds=this.bounds||Crafty.map.boundaries(),final_zoom=amt?this._zoom*amt:1,czoom=final_zoom/this._zoom;this._zoom=final_zoom;act.width=bounds.max.x-bounds.min.x;act.height=bounds.max.y-bounds.min.y;var new_s={width:act.width*final_zoom,height:act.height*final_zoom};Crafty.viewport.pan("reset");Crafty.stage.inner.style["transform"]=Crafty.stage.inner.style[prop]="scale("+this._zoom+","+this._zoom+")";if(Crafty.canvas._canvas){Crafty.canvas.context.scale(czoom,czoom);Crafty.DrawManager.drawAll()}}}(),mouselook:function(){var active=false,dragging=false,lastMouse={};old={};return function(op,arg){if(typeof op=="boolean"){active=op;if(active){Crafty.mouseObjs++}else{Crafty.mouseObjs=Math.max(0,Crafty.mouseObjs-1)}return}if(!active)return;switch(op){case"move":case"drag":if(!dragging)return;diff={x:arg.clientX-lastMouse.x,y:arg.clientY-lastMouse.y};Crafty.viewport.x+=diff.x;Crafty.viewport.y+=diff.y;Crafty.viewport._clamp();case"start":lastMouse.x=arg.clientX;lastMouse.y=arg.clientY;dragging=true;break;case"stop":dragging=false;break}}}(),_clamp:function(){if(!this.clampToEntities)return;var bound=this.bounds||Crafty.map.boundaries();bound.max.x*=this._zoom;bound.min.x*=this._zoom;bound.max.y*=this._zoom;bound.min.y*=this._zoom;if(bound.max.x-bound.min.x>Crafty.viewport.width){bound.max.x-=Crafty.viewport.width;if(Crafty.viewport.x<-bound.max.x){Crafty.viewport.x=-bound.max.x}else if(Crafty.viewport.x>-bound.min.x){Crafty.viewport.x=-bound.min.x}}else{Crafty.viewport.x=-1*(bound.min.x+(bound.max.x-bound.min.x)/2-Crafty.viewport.width/2)}if(bound.max.y-bound.min.y>Crafty.viewport.height){bound.max.y-=Crafty.viewport.height;if(Crafty.viewport.y<-bound.max.y){Crafty.viewport.y=-bound.max.